// –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
const { PrismaClient } = require('@prisma/client')

async function testDatabaseConnection() {
  console.log('üîç –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö...\n')

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
  console.log('üìã –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:')
  console.log('DATABASE_URL:', process.env.DATABASE_URL ? '‚úÖ –ù–∞–π–¥–µ–Ω' : '‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω')
  console.log('JWT_SECRET:', process.env.JWT_SECRET ? '‚úÖ –ù–∞–π–¥–µ–Ω' : '‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω')
  
  if (!process.env.DATABASE_URL) {
    console.log('\n‚ùå DATABASE_URL –Ω–µ –Ω–∞–π–¥–µ–Ω!')
    console.log('üí° –†–µ—à–µ–Ω–∏–µ:')
    console.log('1. –°–æ–∑–¥–∞–π—Ç–µ .env.local —Ñ–∞–π–ª')
    console.log('2. –î–æ–±–∞–≤—å—Ç–µ DATABASE_URL –¥–ª—è PostgreSQL –∏–ª–∏ SQLite')
    console.log('3. –î–ª—è Vercel: –¥–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –≤ Dashboard')
    return
  }

  const prisma = new PrismaClient()

  try {
    console.log('\nüì° –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î...')
    await prisma.$connect()
    console.log('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ!')

    console.log('\nüìã –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞–±–ª–∏—Ü...')
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∞–±–ª–∏—Ü—É users
    try {
      const userCount = await prisma.user.count()
      console.log('‚úÖ –¢–∞–±–ª–∏—Ü–∞ users –¥–æ—Å—Ç—É–ø–Ω–∞, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', userCount)
    } catch (error) {
      console.log('‚ùå –¢–∞–±–ª–∏—Ü–∞ users –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞:', (error as Error).message)
      console.log('üí° –ó–∞–ø—É—Å—Ç–∏—Ç–µ: npx prisma db push')
    }

    // –¢–µ—Å—Ç–∏—Ä—É–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    console.log('\nüë§ –¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...')
    try {
      const testEmail = 'test-' + Date.now() + '@example.com'
      const testUser = await prisma.user.create({
        data: {
          email: testEmail,
          password: '$2a$12$test.hash.password',
          name: 'Test User',
          subscriptionStatus: 'FREE',
          usageCountDay: 0,
          usageCountMonth: 0,
        }
      })

      console.log('‚úÖ –¢–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω:', testUser.email)
      
      // –£–¥–∞–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      await prisma.user.delete({
        where: { id: testUser.id }
      })
      console.log('‚úÖ –¢–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª–µ–Ω')

    } catch (error) {
      console.log('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', (error as Error).message)
    }

    console.log('\nüéâ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –≥–æ—Ç–æ–≤–∞ –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏!')

  } catch (error) {
    console.error('\n‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ë–î:', (error as Error).message)
    console.log('\nüí° –í–æ–∑–º–æ–∂–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è:')
    console.log('1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ DATABASE_URL')
    console.log('2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ë–î –¥–æ—Å—Ç—É–ø–Ω–∞')
    console.log('3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ: npx prisma db push')
    console.log('4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –ë–î')
  } finally {
    await prisma.$disconnect()
  }
}

testDatabaseConnection()
