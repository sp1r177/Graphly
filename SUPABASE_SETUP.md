# Настройка Supabase для аутентификации

## Шаги настройки

### 1. Настройка проекта Supabase

1. Перейдите на [supabase.com](https://supabase.com) и создайте новый проект
2. В разделе Settings > API найдите:
   - `Project URL` 
   - `anon public` ключ

### 2. Настройка переменных окружения

Создайте файл `.env.local` в корне проекта:

```env
# Supabase Configuration
NEXT_PUBLIC_SUPABASE_URL=your_supabase_project_url_here
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key_here

# Site URL for redirects
NEXT_PUBLIC_SITE_URL=http://localhost:3000
```

### 3. Настройка базы данных

1. Откройте SQL Editor в вашем Supabase проекте
2. Скопируйте содержимое файла `supabase-setup.sql` и выполните его
3. Это создаст необходимые таблицы и настроит безопасность

### 4. Настройка аутентификации

1. В Supabase Dashboard перейдите в Authentication > Settings
2. В разделе "Site URL" добавьте: `http://localhost:3000`
3. В разделе "Redirect URLs" добавьте: `http://localhost:3000/auth/callback`
4. Включите "Enable email confirmations" для подтверждения email

### 5. Настройка email провайдера (опционально)

По умолчанию Supabase использует встроенный SMTP сервис с ограничениями.
Для production рекомендуется настроить собственный SMTP:

1. Перейдите в Authentication > Settings > SMTP Settings
2. Настройте ваш SMTP провайдер (например, SendGrid, Mailgun)

### 6. Установка зависимостей

```bash
npm install @supabase/supabase-js
```

## Особенности реализации

### Подтверждение email
- При регистрации пользователь получает письмо с подтверждением
- После клика по ссылке происходит редирект на `/auth/callback`
- Callback страница обрабатывает подтверждение и создает профиль пользователя

### Структура данных
- `user_profiles` - дополнительная информация о пользователе
- `generations` - история генераций контента
- `payments` - история платежей

### Безопасность
- Включен Row Level Security (RLS)
- Пользователи могут видеть только свои данные
- Автоматическое создание профиля при регистрации

## Тестирование

1. Запустите проект: `npm run dev`
2. Откройте http://localhost:3000
3. Попробуйте зарегистрироваться с реальным email
4. Проверьте почту и подтвердите регистрацию
5. Попробуйте войти в систему

## Возможные проблемы

### Email не приходит
- Проверьте настройки SMTP в Supabase
- Проверьте папку "Спам"
- В development режиме письма могут задерживаться

### Ошибки подключения
- Проверьте правильность URL и ключей в `.env.local`
- Убедитесь что Supabase проект активен

### Проблемы с базой данных
- Убедитесь что SQL скрипт выполнен полностью
- Проверьте логи в Supabase Dashboard

## Миграция с Prisma

Данная реализация заменяет Prisma на Supabase. Старые API роуты обновлены для работы с Supabase Auth.

Основные изменения:
- Удалена зависимость от JWT токенов
- Аутентификация теперь управляется Supabase
- Добавлено подтверждение email
- Улучшена безопасность с помощью RLS
