# Настройка Yandex GPT 5.1 Pro

## 1. Получение API ключей

1. Зарегистрируйтесь в [Yandex Cloud](https://cloud.yandex.ru/)
2. Создайте платежный аккаунт
3. Перейдите в раздел "AI и машинное обучение" → "YandexGPT"
4. Создайте сервисный аккаунт и получите API ключ
5. Создайте папку (folder) и получите её ID

## 2. Переменные окружения

Добавьте следующие переменные в ваш `.env.local` файл:

```env
# Yandex GPT 5.1 Pro (поддерживаются оба варианта названий)
YANDEX_API_KEY="your-yandex-gpt-api-key"  # или YANDEX_GPT_API_KEY
YANDEX_FOLDER_ID="your-yandex-cloud-folder-id"  # или YANDEX_GPT_FOLDER_ID
YANDEX_GPT_ASYNC_MODE="false"  # false для синхронного режима (быстрее), true для асинхронного (дешевле)

# Дополнительные переменные (опционально)
YANDEX_CLOUD_ID="your-cloud-id"  # не используется в коде, но может быть полезен
YANDEX_GPT_MODEL="yandexgpt-5.1-pro"  # не используется в коде
```

## 3. Установка зависимостей

```bash
npm install axios
```

## 4. Миграция базы данных

После обновления схемы Prisma выполните миграцию:

```bash
npx prisma migrate dev --name add-token-tracking
npx prisma generate
```

## 5. Режимы работы и стоимость

### Синхронный режим (YANDEX_GPT_ASYNC_MODE="false") - РЕКОМЕНДУЕТСЯ:
- **Стоимость**: 0.40₽ за 1000 токенов
- **Время отклика**: Мгновенное (1-3 секунды)
- **Применение**: Чат-боты, интерактивные приложения, генерация контента
- **Преимущества**: Быстрый ответ, лучше для пользователей

### Асинхронный режим (YANDEX_GPT_ASYNC_MODE="true"):
- **Стоимость**: 0.20₽ за 1000 токенов (в 2 раза дешевле!)
- **Время отклика**: 10-60 секунд
- **Применение**: Массовая генерация контента, фоновые задачи
- **Ограничения**: Пользователи не будут ждать

### Что такое 1000 токенов?
- **Примерно 750-800 слов** на русском языке
- **1 токен ≈ 0.75 слова** (зависит от языка)
- **Средний пост ВК**: 50-100 токенов
- **Статья блога**: 500-2000 токенов
- **Email-кампания**: 200-800 токенов

### Лимиты по подпискам:

#### Бесплатный план (FREE):
- 10 генераций в день ИЛИ 5000 токенов в день
- Стоимость после лимита: 0.20₽ за 1000 токенов (асинхронный)

#### Pro план:
- 100 генераций в месяц ИЛИ 50000 токенов в месяц
- Стоимость после лимита: 0.20₽ за 1000 токенов (асинхронный)

#### Ultra план:
- Безлимитные генерации и токены
- Стоимость: 0.20₽ за 1000 токенов (асинхронный)

## 6. Мониторинг использования

API возвращает информацию о:
- Количестве использованных токенов
- Оставшихся токенах (дневных/месячных)
- Статусе подписки

## 7. Обработка ошибок

Система автоматически переключается на fallback генерацию при:
- Недоступности Yandex GPT API
- Превышении лимитов Yandex Cloud
- Ошибках аутентификации

## 8. Тестирование

Для проверки работы API используйте:

```bash
curl -X POST http://localhost:3000/api/generate \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -d '{
    "prompt": "Создай пост о новом продукте",
    "templateType": "VK_POST"
  }'
```

## 9. Мониторинг в Yandex Cloud

- Отслеживайте использование в консоли Yandex Cloud
- Настройте алерты при превышении лимитов
- Мониторьте расходы в разделе "Биллинг"
